<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frontend API Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #1a1a1a; 
            color: white; 
        }
        .result { 
            background: #2a2a2a; 
            padding: 15px; 
            border-radius: 5px; 
            margin: 10px 0; 
            white-space: pre-wrap; 
            font-family: 'Courier New', monospace; 
        }
        .success { border-left: 4px solid #4CAF50; }
        .error { border-left: 4px solid #f44336; }
        .info { border-left: 4px solid #2196F3; }
        button { 
            background: #0066cc; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 5px; 
            cursor: pointer; 
            margin: 5px; 
        }
        button:hover { background: #0052a3; }
    </style>
</head>
<body>
    <h1>üîç Frontend API Test</h1>
    <p>Testing API calls from frontend (port 5174) to backend (port 5001)</p>
    
    <button onclick="testDirectFetch()">Test Direct Fetch</button>
    <button onclick="testWithCredentials()">Test with Credentials</button>
    <button onclick="testAPIClientMethod()">Simulate API Client</button>
    <button onclick="clearResults()">Clear Results</button>
    
    <div id="results"></div>

    <script>
        const log = (message, type = 'info') => {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            results.appendChild(div);
        };

        const clearResults = () => {
            document.getElementById('results').innerHTML = '';
        };

        // Test 1: Direct fetch call
        async function testDirectFetch() {
            log('üöÄ Starting direct fetch test...', 'info');
            try {
                const response = await fetch('http://localhost:5001/api/dashboard/metrics');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                log('‚úÖ Direct fetch successful!', 'success');
                log('Response data: ' + JSON.stringify(data, null, 2), 'info');
                
            } catch (error) {
                log('‚ùå Direct fetch failed: ' + error.message, 'error');
                log('Error details: ' + JSON.stringify({
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                }, null, 2), 'error');
            }
        }

        // Test 2: Fetch with credentials (like the API client)
        async function testWithCredentials() {
            log('üöÄ Starting fetch with credentials test...', 'info');
            try {
                const response = await fetch('http://localhost:5001/api/dashboard/metrics', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include' // This matches the API client
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                log('‚úÖ Fetch with credentials successful!', 'success');
                log('Response data: ' + JSON.stringify(data, null, 2), 'info');
                
            } catch (error) {
                log('‚ùå Fetch with credentials failed: ' + error.message, 'error');
                log('Error details: ' + JSON.stringify({
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                }, null, 2), 'error');
            }
        }

        // Test 3: Simulate API client method behavior
        async function testAPIClientMethod() {
            log('üöÄ Starting API client simulation...', 'info');
            try {
                // This mimics what the APIClient.get() method does
                const baseUrl = 'http://localhost:5001/api';
                const endpoint = '/dashboard/metrics';
                const url = `${baseUrl}${endpoint}`;
                
                log(`Making request to: ${url}`, 'info');
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include'
                });
                
                log(`Response status: ${response.status} ${response.statusText}`, 'info');
                log(`Response headers: ${JSON.stringify(Object.fromEntries(response.headers.entries()), null, 2)}`, 'info');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                log('‚úÖ API client simulation successful!', 'success');
                log('Response data: ' + JSON.stringify(data, null, 2), 'info');
                
                // Test the transformation logic
                const overallHealth = (data.cpu_usage + data.memory_usage + data.disk_usage) / 3;
                let overallStatus = 'Healthy';
                
                if (overallHealth > 80) overallStatus = 'Critical';
                else if (overallHealth > 60) overallStatus = 'Degraded';
                
                const transformedData = {
                    overallStatus,
                    systems: [
                        {
                            name: 'IDS Engine',
                            status: data.cpu_usage > 80 ? 'Degraded' : 'Online',
                            health: 100 - data.cpu_usage
                        },
                        {
                            name: 'Threat Intelligence',
                            status: 'Online',
                            health: 95
                        },
                        {
                            name: 'Network Monitor',
                            status: data.memory_usage > 80 ? 'Degraded' : 'Online',
                            health: 100 - data.memory_usage
                        },
                        {
                            name: 'Log Analysis',
                            status: data.disk_usage > 90 ? 'Degraded' : 'Online',
                            health: 100 - data.disk_usage
                        }
                    ]
                };
                
                log('‚úÖ Data transformation successful!', 'success');
                log('Transformed data: ' + JSON.stringify(transformedData, null, 2), 'info');
                
            } catch (error) {
                log('‚ùå API client simulation failed: ' + error.message, 'error');
                log('Error details: ' + JSON.stringify({
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                }, null, 2), 'error');
            }
        }

        // Run initial test on page load
        window.addEventListener('load', () => {
            log('üì± Frontend API Test page loaded', 'info');
            log('Current page URL: ' + window.location.href, 'info');
            log('Testing from frontend (5174) to backend (5001)', 'info');
        });
    </script>
</body>
</html>
